<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Información de Factura</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }

        table, th, td {
            border: 1px solid black;
        }

        th, td {
            padding: 10px;
            text-align: left;
        }

        /* Estilo adicional para las tablas internas */
        table table {
            border: none; /* Elimina los bordes de la tabla interna */
            width: 100%;
            margin: 0; /* Elimina los márgenes internos de la tabla interna */
        }
    </style>
</head>
<body>
    <h2>Información de pedidos</h2>

    <table id="facturaTable">
    </table>

    <script>

     fetch(`/facturadatos`)
    .then(response => response.json())
    .then(data => { 
        const tabla = document.getElementById("facturaTable");

        // Campos específicos que deseas mostrar, incluyendo los del campo "payer"
        const camposAMostrar = ["idTransaccion", "transaction_amount", "status", "status_detail","transaction_details.net_received_amount","payer.identification.number", "payer.identification.type","payer.phone.number","payer.email","payer.phone.area_code","payer.phone.extension","pedido"/*,"facturab","entregado"*/];

        // Crear la fila de encabezado
        const filaEncabezado = tabla.insertRow();

        // Llenar la fila de encabezado con los nombres de los campos específicos
        camposAMostrar.forEach(campo => {
            const th = document.createElement("th");
            th.textContent = campo;
            filaEncabezado.appendChild(th);
        });

        //botones

        const th = document.createElement("th");
        th.textContent = "Factura";
        filaEncabezado.appendChild(th);
        const th2 = document.createElement("th");
       th2.textContent = "entregar/pendiente";
        filaEncabezado.appendChild(th2);

        // Iterar sobre los objetos en el array y agregar filas a la tabla
        data.forEach(objeto => {
            const filaDatos = tabla.insertRow();

            camposAMostrar.forEach(campo => {
                const td = document.createElement("td");
                const valorColumna = obtenerValor(objeto, campo);
                td.textContent = valorColumna;
                filaDatos.appendChild(td);
            });
            // Crea un botón
            const td = document.createElement("td");
            var boton = document.createElement('button');
            boton.innerHTML = 'ver factura';
            
            // Agrega un evento de clic al botón para redireccionar a una página específica
            boton.addEventListener('click', function() {
                const id = obtenerValor(objeto,"idTransaccion");
                // Redirecciones a pagina de todos los  producto
                 location.href = "/facturab/"+ id;

            });
            td.appendChild(boton);
            filaDatos.appendChild(td);

            const td2 = document.createElement("td");
            var boton = document.createElement('button');
            boton.innerHTML = 'entregar';

            boton.onclick = function() {
                editarFactura(obtenerValor(objeto, "idTransaccion"), "entregado");
            };
            td2.appendChild(boton);

            //segundo boton
            var boton2 = document.createElement('button');
            boton2.innerHTML = 'rechazar';

            boton2.onclick = function() {
                editarFactura(obtenerValor(objeto, "idTransaccion"), "rechazado");
            };
            td2.appendChild(boton2);
            filaDatos.appendChild(td2);
            
        });
    })
    .catch(error => console.error('Error al obtener datos:', error));

// Función para obtener el valor de una propiedad anidada
function obtenerValor(objeto, propiedad) {
    const propiedades = propiedad.split('.');
    return propiedades.reduce((valor, prop) => valor[prop], objeto);
}




//editar pedidos

async function editarFactura(idFactura, nuevoCampo) {
    try {
    const respuesta = await fetch(`/pedido/${idFactura}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ nuevoCampo }),
    });

    if (!respuesta.ok) {
      const error = await respuesta.json();
      console.error('Error al editar factura:', error);
    } else {
      const facturaActualizada = await respuesta.json();
      console.log('Factura actualizada:', facturaActualizada);
      // Aquí puedes realizar acciones adicionales después de la actualización
    }
  } catch (error) {
    console.error('Error de red:', error);
  }
}

    </script>
</body>
</html>




